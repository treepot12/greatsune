<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>그레잇썬주식회사</title>
    <style>
        textarea {
            /* border:none; */
            resize:none;
            width:700px;
        }
        #title{
            overflow:hidden;
            font-size: 30px;
        }
    </style>
</head>
<body>
    <h1 onclick="logo()">그레잇썬주식회사</h1>
    <hr>
    <form id="postform">
        <textarea id="title" maxlength="20" rows="1" placeholder="제목"></textarea>
        <hr>
        <textarea id="content"  rows="30" placeholder="글을 입력하십시오."></textarea>
        <input type="file" id="f" multiple>
        <p></p>
        <input type="submit" value="제출">
    </form>
</body>
<script type="module">
    import "./logo.js";
    import { addDoc, collection, serverTimestamp, getFirestore } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { db, storage, auth } from "./app.js";
    document.getElementById("title").addEventListener('keydown', function(e){
        if (e.key == 'Enter'){
            e.preventDefault();
        }
    })
    document.getElementById("postform").addEventListener("submit", async(e) => {
        e.preventDefault();

        const title = document.getElementById("title").value;
        const content = document.getElementById("content").value;
        const files = document.getElementById("f").files;

        const upfile = [];

        for (const file of files) {
            const fileName = `${Date.now()}_${file.name}`;
            const uid = auth.currentUser.uid;
            const fileRef = ref(storage, `uploads/${uid}/${fileName}`);

            await uploadBytes(fileRef, file);
            const fileURL = await getDownloadURL(fileRef);

            upfile.push({
                name: file.name,
                url: fileURL,
                type: file.type,
                size: file.size
            });
        }

        await addDoc(collection(db, "posts"), {
            title,
            content,
            files: upfile,
            createdAt: serverTimestamp()
        });

        alert("저장됨");
        location.href="https://treepot12.github.io/greatsune/board.html";

    });
    // document.getElementById("title").addEventListener('input', function(){
    //     if (this.value.length >30){
    //         this.value = this.value.slice(30);
    //     }
    // })
</script>
</html>